import pandas as pd
import matplotlib.pyplot as plt
import os
from main import Peak_Integration, Get_Convention, Get_Gradient_Color

def Integrate_And_Plot_Bar_Graph(readpath):
    # Load consolidated spectra from the CSV generated by the first script
    df_tot = pd.read_csv(readpath)

    # Define wavenumber regions of interest for peak integration
    wn_low = [780, 830, 970, 2100, 2930, 3060]
    wn_high = [830, 930, 1150, 2225, 3000, 3080]
    groupname = ['Si-CH3', 'Si-H (bend)', 'Si-O-Si', 'Si-H (stretch)', 'CH3', 'vinyl (C=C)']

    # Create a dataframe to store peak areas
    df_area = pd.DataFrame(index=groupname)

    # Convert wavenumbers to indices
    wn_array = df_tot['cm-1'].to_numpy()

    # Plot initialization and color settings
    color_list = []
    num_samples = len(df_tot.columns) - 1
    for i, columnname in enumerate(df_tot.columns[1:]):  # Skip the 'cm-1' column
        agent_loading, time_in_seconds = columnname.split("_")[0], columnname.split("_")[1]
        
        # Integrate the peak areas
        wn_corrected = df_tot[columnname].to_numpy()
        area = Peak_Integration(wn_corrected, wn_array, wn_low, wn_high)
        df_area[columnname] = area

        # Conditional formatting for colors
        base_color = Get_Convention('agent-loading', agent_loading)
        color = Get_Gradient_Color(base_color, 1 - i/num_samples)  # Invert the gradient
        color_list.append(color)

    # Plot the bar graph for peak areas
    ax_area = df_area.plot.bar(title='Peak Areas', rot=30, color=color_list)
    ax_area.set_title('Peak Areas')
    plt.show()

    # Export the integrated peak areas to a CSV
    writepath = 'peak_areas.csv'
    df_area.to_csv(os.path.join(os.path.dirname(readpath), writepath))

##----------------------------MAIN CODE START----------------------------##

readpath = r"exports\oven_5ppt-vs-0ppt_consolidated.csv"
Integrate_And_Plot_Bar_Graph(readpath)
